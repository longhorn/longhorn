# Longhorn Backupstores (Kustomize + Dynamic Credentials)

This directory provides manifest templates to deploy **test-ready backup targets** for Longhorn, including:

- Azurite (Azure Blob-compatible)
- CIFS (SMB mount)
- MinIO (S3-compatible object storage)

All secrets are generated **dynamically** at runtime using Kustomize patches, to avoid committing hardcoded credentials.

---

## Purpose

For security concerns related to credential exposure, we avoid static credential exposure in Git. Instead, we generate the Kustomize patches dynamically through a script to simulate test credentials without committing them.

---

## Directory Structure

> Note: `overlays/` will be generated by `generate-backupstore-credentials.sh`

```
deploy/backupstores/
├── base
│   ├── azurite
│   │   ├── azurite-backupstore.yaml
│   │   └── kustomization.yaml
│   ├── cifs
│   │   ├── cifs-backupstore.yaml
│   │   └── kustomization.yaml
│   ├── minio
│   │   ├── kustomization.yaml
│   │   └── minio-backupstore.yaml
│   └── nfs
│       ├── kustomization.yaml
│       └── nfs-backupstore.yaml
├── overlays
│   └── generated-credentials
│       ├── all
│       │   └── kustomization.yaml
│       ├── azurite
│       │   ├── azurite-backupstore-secret-patch-longhorn-system.yaml
│       │   └── kustomization.yaml
│       ├── cifs
│       │   ├── cifs-backupstore-secret-patch-default.yaml
│       │   ├── cifs-backupstore-secret-patch-longhorn-system.yaml
│       │   └── kustomization.yaml
│       ├── minio
│       │   ├── kustomization.yaml
│       │   ├── minio-backupstore-secret-patch-default.yaml
│       │   └── minio-backupstore-secret-patch-longhorn-system.yaml
│       └── nfs
│           └── kustomization.yaml
└── README.md

```

---

## Script: `generate-backupstore-credentials.sh`

This script generates dummy secret patches for one or more backends.
It supports two namespaces: `default` and `longhorn-system`.

⚠️ Be careful not to double-encode values.
If using `--no-encode`, ensure your environment variables are already base64-encoded exactly once.

### Preconfigured credentials (edit as needed)

> **Credential Notes:**
>
> - Kubernetes secrets require base64-encoded values.
> - The script supports both:
>   - **Plaintext input (default)**: The script will automatically base64-encode values before writing them into Secret manifests.
>   - **Base64-encoded input**: Use the `--no-encode` flag to use your values as-is without re-encoding.

In `generate-backupstore-credentials.sh`:

```bash
# Azurite
export AZBLOB_ACCOUNT_NAME="example-azblob-account"
export AZBLOB_ACCOUNT_KEY="example-azblob-key"
export AZBLOB_ENDPOINT="http://azblob-service.default:10000"

# CIFS 
export CIFS_USERNAME="example-cifs-username"
export CIFS_PASSWORD="example-cifs-password"

# MinIO 
export AWS_ACCESS_KEY_ID="example-minio-access-key"
export AWS_SECRET_ACCESS_KEY="example-minio-secret-key"
export AWS_ENDPOINTS="https://minio-service.default:9000"
export AWS_CERT="example-base64-cert"         
export AWS_CERT_KEY="example-base64-cert-key"
```

### Options

- `<backend>`: One of `azurite`, `cifs`, `minio`, `nfs` or `all`. Required.
- `--no-encode` (optional): Indicates that the provided values are already base64-encoded and should be used as-is without additional encoding.
### Usage

**Generate credentials for a single backend**

```bash
./scripts/generate-backupstore-credentials.sh minio 
```

**Generate credentials for all backends**

```bash
./scripts/generate-backupstore-credentials.sh all
```

**By default, secrets are base64-encoded. Use --no-encode if the input is already base64.**

```bash
./scripts/generate-backupstore-credentials.sh minio --no-encode
```

### Deploy / Delete

**Deploy / Delete one backend**

```bash
kubectl apply -k deploy/backupstores/overlays/generated-credentials/minio
```

```bash
kubectl delete -k deploy/backupstores/overlays/generated-credentials/minio
```

**Deploy / Delete all**

```bash
kubectl apply -k deploy/backupstores/overlays/generated-credentials/all
```

```bash
kubectl delete -k deploy/backupstores/overlays/generated-credentials/all
```
